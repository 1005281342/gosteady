# 负载均衡技巧



## 负载均衡算法

| 算法     | 基本原理                                                     | 适应场景                                                     | 优点                           | 缺点                                                         |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------ | ------------------------------------------------------------ |
| 轮询     | 将请求依此发给服务器                                         | 通用，无状态的负载均衡                                       | 实现简单                       | 不会判断服务器状态，除非服务器连接丢失                       |
| 随机     | 将请求随机发给服务器                                         | 通用，无状态的负载均衡                                       | 实现简单                       | 不会判断服务器状态，除非服务器连接丢失                       |
| 加权轮询 | 按照预先配置的权重，将请求按照权重比例发送给不同的服务器     | 服务器的处理能力有差异，例如新老服务器搭配使用               | 请求分配可以被用户通过权重协调 | 1.实现复杂，按照权重配置。2. 不会判断服务器状态，除非服务器连接丢失。3. 权重配置不合理可能导致过载。 |
| 负载优先 | 负载均衡系统将任务分配给当前负载最低的服务器，这里的负载根据不同的任务类型和业务场景，可以用不同的指标衡量 | LVS 这种4层网络负载均衡设备，可以以“连接数”来判断服务器的状态，服务器连接数越大，表明服务器压力越大；Nginx 这种7层网络负载系统，可以以“HTTP”请求数来判断服务器状态（Nginx 内置的负载均衡算法不支持这种方式，需要进行扩展） | 可以根据服务器状态进行负载均衡 | 实现复杂，需要管理或者获取服务器的状态                       |
| 性能优先 | 负载均衡系统将任务分配给当前性能最高的服务器，主要是以响应时间作为性能衡量标准 | Nginx 这种7层网络负载系统，可以以“HTTP 响应时间”来判断服务器状态（Nginx 内置的负载均衡算法不支持这种方式，需要进行扩展） | 可以根据性能进行负载均衡       | 实现复杂，需要统计（采样）请求处理时间，需要耗费一定的 CPU 运算资源；可以根据性能进行负载均衡； |
| Hash     | 基于某个参数计算 hash 值，将其映射到具体的服务器             | 有状态的任务（如购物车）；任务是分片的（如某个用户的请求只能在某台服务器处理） | 实现简单                       | 不会判断服务器状态，除非服务器连接丢失                       |



### 加权轮询算法相关策略

#### 请求数量

权重配置为请求数量。

如：给服务器1发送 40 个请求，然后再给服务器2发送40个请求，然后再给服务器3发送20个请求。实现简单，但服务器资源利用可能不均衡，会出现毛刺现象，例如配置了[200, 50, 20]。但如果配置[2, 2, 1]的话，这种算法运行良好。

#### 权重概率

将所有服务器的权重加起来，然后计算各个服务器的分配概率，用随机数区间来做分配。例如：服务器[0, 39]，服务器2[40, 79]，服务器3[80, 99]，生成 [0, 99] 的随机数，落入哪个区间就用哪个服务器。

#### 权重动态调整

Nginx 的实现，兼顾服务器故障后的慢启动。



## Q & A

 ### 轮询、随机策略负载均衡的问题场景

1. 某个服务器当前因为触发了程序 bug 进入了死循环导致 CPU 负载很高，负载均衡系统是不感知的，还是会继续将请求源源不断地发送给它。
2. 集群中有新的机器也是 32 核的，老的机器是 16 核的，负载均衡系统也是不关注的，新老机器分配的任务数是一样的。

### 加权轮询会因为权重配置不当导致过载

新采购的机器性能预估是旧机器的 1 倍，但是运维配置的权重为 2 倍，结果导致新机器全部过载。
