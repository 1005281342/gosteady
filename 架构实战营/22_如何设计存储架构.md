## 存储架构设计整体思路

### 存储架构设计三个步骤

1. 估算性能需求
   - 任务：基于具体的任务场景来估算性能需求，包括存储量、读写性能等。
   - 挑战：如何估算？估算不准？
2. 选择存储系统
   - 任务：根据技术储备、方案优缺点选择合适的存储系统。
   - 挑战：不知道有哪些存储系统；知道但是不知道怎么选
3. 设计存储方案
   - 任务：基于选择的存储系统，设计其具体的存储方案，如果发现不行，回到步骤2换一个
   - 挑战：如何设计存储方案？



## 如何估算业务所需存储性能

### 估算模型

```mermaid
graph LR
用户量预估 --> 用户行为建模 --> 性能需求计算
```

架构师在2B业务中需要同客户、解决方案架构师澄清他们预估的用户量，在2C业务中需要同产品人员、运营人员、老板沟通去做决策给出用户量预估。

### 用户量预估

- 规划：根据成本、预算、目标等确定
- 推算：基于已有数据推算
- 对比：根据已有标杆对比

注意：用户不一定是人，对于云平台来说接入对象是公司也就是说用户是公司



### 用户行为建模

- 行为：用户的典型行为
- 数量：某种行为的用户数量
- 频率：用户某种行为的频率



### 存储性能的需求计算

- 数据量：需要存储的数据总量
- 请求量：对数据的读写请求量分析，评估参考 TPS、QPS等
- 预留量：预留的增长空间

说明和技巧：

1. 并不是所有的数据都一定要用同样的存储方式，例如当前数据和历史数据可以分开存储
2. TPS/QPS 需要计算出以秒为单位的树枝，并且计算“平均值”和“峰值”
3. 预留空间要合适，如果能做到线性伸缩是最好的



### 存储性能需求计算案例

案例：每天使用扫码乘车的用户有 500 万（用户量），平均扫码次数 4.6 次（用户行为模型）

部分分析和计算过程：

1. 假设总用户数 1000 万，则用户数据存储量是 1000 万
2. 每次扫码乘车，都需要访问一次用户数据，则用户数据读取次数为：500 万 * 4.6 约为 2300 万
3. 每次扫码乘车，都会生成一条乘车记录，则单日乘车记录数为：500 万 * 4.6 约为 2300 万
4. 乘车记录要保存 2 年，则总数据量为 2300 万 * 800  约为 200 亿
5. 每条乘车记录对应一条乘车记录，单日支付记录数月 2300 万，两年总数量月 200 亿
6. 地铁乘车 60% 集中在早晚高峰的 2 个小时内，因此乘车记录写入峰值 TPS 平均月为 2300 万 * 60% / （2 * 3600）约为 2000



## 如何选择存储架构

### 存储架构选择逻辑

```mermaid
graph TD;
    style A fill:#7FCDBB,stroke:#333,stroke-width:2px;
    style C fill:#FEE391,stroke:#333,stroke-width:2px;
    style E fill:#FCAE91,stroke:#333,stroke-width:2px;
    subgraph 存储性能估算
        A[存储性能估算<br>结果] 
    end
    subgraph 单机部署
        C{单机能否存储所有数据}
        D{单机能否支撑写性能}
        F{单机能够支撑读性能}
    end
    subgraph 分布式部署
        E{是否需要分区部署}
        G{是否需要自动切换}
        G2{是否需要自动切换}
    end
    subgraph 部署架构
        分区架构[分区架构]
        分片架构[分片架构]
    end
    
    A --> C;
    C -->|是| D;
    C -->|否| E;
    D -->|是| F;
    D -->|否| E;
    F -->|是| G;
    F -->|否| G2;
    G -->|是| 主备切换[主备切换]
    G -->|否| 主备复制[主备复制]
    G2 -->|是| 主从切换[主从切换]
    G2 -->|是| 集群选举[集群选举]
    G2 -->|否| 主从复制[主从复制]
    E -->|是| 分区架构;
    E -->|否| 分片架构;

```

### 场景存储系统分类

```mermaid
graph TD;
存储系统 -->|关系型| SQL;
存储系统 -->|非关系型| NoSQL;
存储系统 -->|分布式| 大数据;
SQL -->|在线事务处理| OLTP;
SQL -->|在线分析处理| OLAP;
NoSQL -->|键值| Redis;
NoSQL -->|文档| MongoDB;
NoSQL -->|搜索| Elasticsearch;
NoSQL -->|时间序列| InfluxDB;
大数据 -->|分布式文件系统| HDFS;
大数据 -->|分布式列式数据库| HBase;
OLTP --> MySQL;
OLTP --> PostgreSQL;
OLAP --> ClickHouse;
OLAP --> Hive;

```

### 如何选择合适的存储系统

```mermaid
graph LR;
技术本质 --> 技术储备 --> 综合考虑
```

- 技术本质，挑选应用场景和系统本质契合的系统
- 技术储备，挑选熟悉的
- 综合考虑，可维护性、成本、成熟度等

#### 什么是技术本质

系统的 DNA，有区别于其他系统的典型特征。比如 MongoDB 是文档型数据库，MySQL 是关系型数据库，Redis 是 kv 数据库等



#### 技术本质有什么影响

技术本质决定了其核心应用场景和优缺点，例如 MongoDB 是文档数据库，优点是 Schemaless，缺点是事务支持不好；Elasticsearch 是搜索引擎而不是存储引擎。