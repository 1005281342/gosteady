# 微服务拆分技巧

## 微服务架构整体思路

### 常见场景实施建议

|                       | 拆分方式         | 基础设施要求                                                 | 落地方式 |
| --------------------- | ---------------- | ------------------------------------------------------------ | -------- |
| 从 0 开始构建业务系统 | 按业务拆分微服务 | 搭建完善基础设施，按照微服务基础设施优先级逐步落地           | 一步到位 |
| 单体架构微服务化      | 按业务拆分微服务 | 搭建完善基础设施，按照微服务基础设施优先级逐步落地           | 逐步落地 |
| 粗粒度服务微服务化    | 按质量拆分微服务 | 搭建核心基础设施。例如：如果按照可用性拆分，则需要服务注册、发现、路由、熔断、降级等这几个微服务基础设施 | 逐步落地 |
| 局部系统优化          | 按质量拆分微服务 | 重用已有基础设施                                             | 逐步落地 |

## 如何按业务拆分微服务

### DDD 概要介绍

#### 战略设计

- 领域，对应微服务的 “子域”
- 限界上下文，对应微服务的 “服务”

#### 战术设计

聚合根、实体、值对象对应面向对象方法的对象

- 聚合根：核心的有状态对象
- 实体：有状态对象
- 值对象：无状态对象

### DDD 难以落地的核心问题

#### 限界上下文的边界如何划分？

DDD 告诉你限界上下文是什么，却没有告诉你如何划分！

“业务部门或者工作组织的划分可以很好地标明模型边界的位置。你将倾向于为每个业务功能寻找至少一位业务专家。”  -- 《领域驱动设计精粹》P21

“团队必须决定在哪里定义 BOUNDED CONTEXT，以及它们之间有什么样的关系。...... 事实上，这样的决策通常需要与外部团队达成一致。...... 在实践中，团队之间的行政关系往往决定了系统的集成方式。”  -- 《领域驱动设计》P268

“设计中的整个系统使用一个 BOUNDED CONTEXT。例如，当一个少于 10 人的团队正在开发高度相关的功能时，这可能就是一个很好的选择。”  -- 《领域驱动设计》P270

### 实际项目中的业务边界划分

优先让业务专家划分；如果没有且不是全新业务可以先参考业界实现；否则先粗后细划分（演讲）

|              | 做法                                                         | 风险             | 技巧         |
| ------------ | ------------------------------------------------------------ | ---------------- | ------------ |
| 业务专家     | 以业务专家意见为准                                           | 业务专家太水     | 从行业挖人才 |
| 粗分 + 演进  | 先按照某个维度粗粒度划分，后面随着业务发展而演进，划分为细粒度边界。 | 太粗导致频繁演进 | 三个火枪手   |
| 参考业界实现 | 直接参考业界类似业务的划分方式                               | 照搬导致水土不服 | 三个火枪手   |

### 服务拆分技巧

1. 划分业务边界
2. 映射领域
3. 推导微服务
   - 服务粒度（三个火枪手原则）
   - 推导技巧（业务对应微服务个数）
     - 一对一
     - 多对一
     - 一对多

#### 三个火枪手原则

平均每三个开发人员负责一个微服务

- 一个人负责没有备份，且一个人思维有局限
- 两个负责，一个分备份时压力比较大，且复杂度偏低，可能成长有限
- 如果是四个或以上的人负责，每个人不一定能掌握单个服务的所有细节

相关技巧：

- 微服务数量 = 服务端开发人数 / 3
- 3 = 1 + 2，1 个有经验的 + 2 个普通的
- 处理维护期的服务，维护人员为 2 人

## 如何按质量属性拆分微服务

| 拆分维度           | 方法                                                         | 目的                                                         |
| ------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 按性能拆分         | 根据运维系统统计请求量排名前 3 的业务，将业务流量最大的业务以及强关联的业务拆分出来 | 降低业务互相影响程度，拆分后优化流量大的业务，提升性能降低成本 |
| 按业务重要程度拆分 | 将重要程度高的业务拆分出来                                   | 降低业务互相影响程度，拆分后提升重要程度高的业务的可用性     |
| 按可用性拆分       | 将经常出问题的业务拆分出来                                   | 降低业务互相影响程度，拆分后有针对性的提升问题多的业务       |
| 按稳定性拆分       | 将稳定的业务拆分出来                                         | 降低业务互相影响程度，拆分后有利于不断变化的业务快速迭代     |

## Q & A

### 为什么微服务拆分建议先粗后细而不是先细后粗？

先粗后细可以通过接口版本进行切换

先细后粗往往可能应为微服务间的联动关系变得困难，合并周期长

