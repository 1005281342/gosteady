[TOC]

# 数据一致性

数据一致性通常指关联数据之间的逻辑关系是否正确和完整，而数据存储的一致性模型则可以认为是存储系统和数据使用者之间的一种约定，如果使用者遵循这种约定，则可以得到系统所承诺的访问结果[[1]](https://cn.pingcap.com/article/post/5950.html)。

数据一致性分为`多副本数据一致性`和`分布式事务数据一致性`。

## 多副本数据一致性

多副本下不同节点之间的数据内容是一样的。

每个保存系统完整数据集的节点称之为`副本`。

### 主从复制

#### 同步复制

主节点写入后还需要等待所有从节点完成写入，并且最新的写入对所有用户可见。

#### 异步复制

在主节点写入完成后，异步复制到从节点。（一般复制到从节点是非常快的）

#### 半同步复制

在数据库中有时会设置一个从节点（从节点数大于 1）复制策略为`同步`。

### 多主节点复制

略

### 无主节点复制

略

## 分布式事务数据一致性

~~分布式事务下不同节点之间的数据内容是不一样的。~~ 

### 事务

事务将应用程序的多个读、写操作捆绑在一起成为一个逻辑操作单元，即事务中的所有读写是一个执行的整体，整个事务要么成功（提交），要么失败（中止或回滚）。如果失败，应用程序可以安全地重试[[2]]()。

### ACID

1. 原子性 (Atomicity)：是系统中不可分解为更小粒度的东西，它只能处于操作之前后操作之后的状态，没有中间状态，在操作失败时可以安全地重试。
2. 一致性 (Consistency)：系统处于应用程序所期待的`预期状态`。
3. 隔离性 (Isolation)：系统中同时运行的多个事务相互隔离，互不干扰。
4. 持久性 (Durability)：成功完成的事务的更改将持久保存，即使系统崩溃也不会丢失。

#### 隔离级别

略

### 单节点事务

在单节点上运行的事务，不需要与其他节点交互，也就不会出现部分节点失败导致的操作分割，我们只需要考虑当前节点整体失败导致的操作分割即可。对于单节点事务，一般是在存储引擎上，通过 `Undo Log`、`Redo Log` 和 `Commit 记录`  来实现[[3]]()。（注：此处提到的存储引擎是 MySQL 的 InnoDB）

### 多节点事务

对于多节点上运行的事务（分布式事务）来说，除了当前节点整体失败导致的操作分割之外，还存在部分节点失败导致的操作分割。我们知道当前节点整体失败导致的操作分割，可以按单节点事务来处理，而对于部分节点失败导致的操作分割，一个常见的思路是通过两阶段提交（ 2PC ）来解决[[3]]()。

#### 两阶段提交（2PC）

2PC 引入了单节点事务所没有的一个新组件：协调者（也称事务管理器）[4]()。

- 选择一个协调者，这个协调者可以是分布式事务的参与节点，也可以是一个单独的进程。
- 阶段 1
  - 协调者发送事务请求（Prepare）到所有的参与节点，并询问它们是否可以提交。
  - 如果所有的参与节点都回复`是`，那么接下来协调者在阶段 2 发出提交（Commit）请求。
  - 如果任何的参与节点都回复`否`，那么接下来协调者在阶段 2 发出放弃（Rollback）请求。
- 阶段 2
  - 依据阶段 1 返回的结果，决定事务最终是提交（Commit）还是放弃（Rollback）。

##### 协调者发生故障

略

#### 三阶段提交（3PC）

略

#### TCC（Try-Confirm-Cancel）

TCC本质上是一个业务层面上的 2PC，他要求业务在使用TCC模式时必须实现三个接口`Try()`、`Confirm()`和`Cancel()`[[5]](https://juejin.cn/post/7017333689109446670)

#### XA

是异构环境下实施两阶段提交的一个工业标准[[6]]()

#### SAGA、本地消息表、事务消息

[[7]聊一下分布式事务](https://albenw.github.io/posts/425b6837/)

## 事务管理器

go 跨语言分布式事务管理器 [dtm](https://github.com/dtm-labs/dtm/blob/main/helper/README-cn.md)

- 支持多种事务模式：SAGA、TCC、XA
- 支持消息最终一致性：二阶段消息，比本地消息表更优雅的方案

## 数据一致性基础理论

### CAP 

在分布式系统中共享数据时，无法同时满足一致性（Consistency）、可用性（Availability）和分区容忍性（Partition tolerance）这三个特性

- 一致性（Consistency）：在分布式系统中的所有节点中，对于任何操作的执行结果都是一致的。换句话说，系统中的所有节点都能够看到相同的数据状态。
- 可用性（Availability）：系统必须对于每个请求都能够给出响应，即系统保持持续的可用性，不会因为节点故障或其他原因导致无法响应客户端请求。
- 分区容忍性（Partition tolerance）：系统能够在网络分区的情况下继续正常运行。网络分区是指分布式系统中的节点之间出现通信故障，导致节点无法相互通信的情况。

分区容忍性是分布式系统的必要属性，需要在`一致性`和`可用性`之间取舍

1. `CP` 需要保证一致性，当节点判断分区发生后，需要拒绝服务
2. `AP` 需要保证可用性，当节点判断分区发生后，返回当前节点上已有的数据值

### BASE

BASE 是指基本可用（Basically Available）、软状态（Soft State）、最终一致性（Eventual Consistency）

核心思想是即使无法做到强一致性（CAP 的一致性就是强一致性），但应用可以采用适合的方式达到最终一致性。

- 基本可用（BA）：读写操作尽可能的可用，但写操作在冲突的时候可能丢失结果，读操作可能读取到旧的值。
- 软状态（S）：没有一致性的保证，允许系统存在中间状态，而该中间状态不会影响系统整体可用性，这里的中间状态就是 CAP 理论中的数据不一致。
- 最终一致性（E）：如果系统运行正常且等待足够长的时间，系统最终将达成一致性的状态。

## 案例

TODO



## 参考

[[1]数据的一致性是什么?数据一致性解决方案概述](https://cn.pingcap.com/article/post/5950.html)

[[2]数据密集型应用系统设计-P211]()

[[3]极客时间-深入浅出分布式技术原理-第23节]()

[[4]数据密集型应用系统设计-P334]()

[[5]分布式事务-2PC与TCC](https://juejin.cn/post/7017333689109446670)

[[6]数据密集型应用系统设计-P334]()

[[7]聊一下分布式事务](https://albenw.github.io/posts/425b6837/)

